# Database Migrations Guide

## Overview

The Control Plane uses Alembic for database schema versioning and migrations. All schema changes should be managed through migrations, not direct `init_models()` calls in production.

## Quick Start

### Initial Setup (First Time)

1. **Ensure database is running:**
   ```bash
   # PostgreSQL should be running and accessible
   # Check connection string in .env or environment variables
   ```

2. **Create initial migration:**
   ```bash
   cd 04-Control-Plane-Orchestrator
   alembic revision --autogenerate -m "Initial schema"
   ```

3. **Review the generated migration:**
   ```bash
   # Check alembic/versions/XXXX_initial_schema.py
   # Verify it looks correct
   ```

4. **Apply the migration:**
   ```bash
   alembic upgrade head
   ```

### Creating New Migrations

When you modify models in `src/control_plane/models.py`:

1. **Generate migration:**
   ```bash
   alembic revision --autogenerate -m "Description of changes"
   ```

2. **Review the generated migration:**
   - Check `alembic/versions/XXXX_description.py`
   - Verify changes are correct
   - Add any manual adjustments if needed

3. **Test the migration:**
   ```bash
   # Apply migration
   alembic upgrade head
   
   # If needed, test rollback
   alembic downgrade -1
   alembic upgrade head
   ```

### Common Commands

```bash
# Show current revision
alembic current

# Show migration history
alembic history

# Upgrade to latest
alembic upgrade head

# Upgrade to specific revision
alembic upgrade <revision>

# Downgrade one revision
alembic downgrade -1

# Downgrade to specific revision
alembic downgrade <revision>

# Generate migration from model changes
alembic revision --autogenerate -m "Description"
```

## Migration Workflow

### Development

1. Modify models in `src/control_plane/models.py`
2. Generate migration: `alembic revision --autogenerate -m "Description"`
3. Review and adjust migration file if needed
4. Test migration: `alembic upgrade head`
5. Commit both model changes and migration file

### Production Deployment

1. **Backup database** (recommended)
2. Run migrations: `alembic upgrade head`
3. Verify schema matches expectations
4. Monitor application startup

### Rollback (If Needed)

```bash
# Rollback one revision
alembic downgrade -1

# Rollback to specific revision
alembic downgrade <revision>
```

## Configuration

### Database URL

The migration system uses the same database URL as the application:
- Environment variable: `DATABASE_URL`
- Default: `postgresql+asyncpg://postgres:postgres@localhost:5432/accord_engine`
- Configured in `src/config.py`

### Alembic Configuration

- Config file: `alembic.ini`
- Migrations directory: `alembic/versions/`
- Script template: `alembic/script.py.mako`

## Best Practices

1. **Always review autogenerated migrations** before applying
2. **Test migrations** on a copy of production data if possible
3. **Keep migrations small and focused** - one logical change per migration
4. **Never edit existing migrations** that have been applied to production
5. **Commit migrations with model changes** - keep them in sync
6. **Document breaking changes** in migration messages

## Troubleshooting

### Migration Conflicts

If migrations diverge:
```bash
# Check current state
alembic current

# Review history
alembic history

# Merge branches if needed (advanced)
alembic merge -m "Merge branch" <rev1> <rev2>
```

### Autogenerate Issues

If autogenerate doesn't detect changes:
1. Ensure models are imported in `alembic/env.py`
2. Check that SQLModel metadata is populated
3. Verify model changes are actually different
4. Manually create migration if needed: `alembic revision -m "Description"`

### Connection Issues

If migrations fail to connect:
1. Verify `DATABASE_URL` is correct
2. Check database is running and accessible
3. Verify credentials and permissions
4. Check network connectivity

## Integration with Application

### Development Mode

The application still uses `init_models()` for quick development setup. This is fine for local development but should not be used in production.

### Production Mode

Production deployments should:
1. Run migrations during deployment: `alembic upgrade head`
2. Disable `init_models()` or make it conditional
3. Use migrations for all schema changes

### Startup Check

You can add a startup check to verify migrations are up to date:
```python
# In main.py lifespan
current_rev = await get_current_revision()
head_rev = await get_head_revision()
if current_rev != head_rev:
    logger.warning(f"Migrations out of date: {current_rev} != {head_rev}")
```

## Notes

- Migrations use async SQLAlchemy/SQLModel
- All migrations are reversible (should have upgrade/downgrade)
- Migration files are version controlled (commit them)
- Never run migrations directly on production without testing first

